<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
    
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Hewlett Packard Enterprise">
  <link rel="shortcut icon" href="../img/favicon.ico">
    <meta property="og:title" content="HPE Storage Container Orchestrator Documentation"/>
    <meta property="og:description" content="This is an umbrella documentation project for all Kubernetes and Docker integrations for HPE primary storage tailored for IT Ops, developers and partners. Including HPE 3PAR and Primera, HPE Cloud Volumes and HPE Nimble Storage."/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:url" content="https://scod.hpedev.io"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://scod.hpedev.io/img/hpe-social-og-image01.jpg"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    
  <title>Using - HPE Storage Container Orchestrator Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/hpedev.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Using";
    var mkdocs_page_input_path = "csi_driver/using.md";
    var mkdocs_page_url = "/csi_driver/using.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79554149-3', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> HPE Storage Container Orchestrator Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">WELCOME</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../welcome/index.html">Get started!</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">HPE CSI DRIVER FOR KUBERNETES</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="index.html">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="deployment.html">Deployment</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="using.html">Using</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#overview">Overview</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#enabling_csi_snapshots">Enabling CSI snapshots</a></li>
        
            <li><a class="toctree-l4" href="#base_storageclass_parameters">Base StorageClass parameters</a></li>
        
            <li><a class="toctree-l4" href="#provisioning_concepts">Provisioning concepts</a></li>
        
            <li><a class="toctree-l4" href="#further_reading">Further reading</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="diagnostics.html">Diagnostics</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">CONTAINER STORAGE PROVIDERS</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../container_storage_provider/hpe_3par_primera/index.html">HPE 3PAR and Primera</a>
                </li>
                <li class="">
                    
    <a class="" href="../container_storage_provider/hpe_nimble_storage/index.html">HPE Nimble Storage</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LEGACY FLEXVOLUME DRIVER</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../flexvolume_driver/container_provider/index.html">Container Provider: Nimble and CV</a>
                </li>
                <li class="">
                    
    <a class="" href="../flexvolume_driver/hpe_3par_primera_installer/index.html">Ansible installer for 3PAR/Primera</a>
                </li>
                <li class="">
                    
    <a class="" href="../flexvolume_driver/dory/index.html">History: Dory and Doryd </a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">DOCKER VOLUME PLUGINS</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../docker_volume_plugins/hpe_cloud_volumes/index.html">HPE Cloud Volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker_volume_plugins/hpe_nimble_storage/index.html">HPE Nimble Storage</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">PARTNER ECOSYSTEMS</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../partners/redhat_openshift/index.html">Red Hat OpenShift</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LEARN</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../learn/containers101/index.html">Cloud-Native, Containers & DevOps</a>
                </li>
                <li class="">
                    
    <a class="" href="../learn/persistent_storage/index.html">Persistent Storage for Kubernetes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">COMMUNITY</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="https://developer.hpe.com">HPE Developer Community</a>
                </li>
                <li class="">
                    
    <a class="" href="https://slack.hpedev.io">Sign up to HPE DEV on Slack</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/hpe-storage/scod/issues/new?title=I have some feedback on SCOD">Got feedback?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">EXTERNAL LINKS</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="https://github.com/hpe-storage/scod">SCOD on GitHub</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/hpe-storage">HPE Storage on GitHub</a>
                </li>
                <li class="">
                    
    <a class="" href="https://hpe.com/storage/containers">Storage for Containers on hpe.com</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LEGAL</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../legal/contributing/index.html">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../legal/support/index.html">Support</a>
                </li>
                <li class="">
                    
    <a class="" href="../legal/license/index.html">License</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">HPE Storage Container Orchestrator Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>HPE CSI DRIVER FOR KUBERNETES &raquo;</li>
        
      
    
    <li>Using</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h1>
<p>At this point the CSI driver and CSP should be configured. If you used either the Helm chart or Operator, you most likely have a base <code>StorageClass</code> to provision storage from.</p>
<div class="toc">
<ul>
<li><a href="#overview">Overview</a><ul>
<li><a href="#enabling_csi_snapshots">Enabling CSI snapshots</a></li>
<li><a href="#base_storageclass_parameters">Base StorageClass parameters</a></li>
<li><a href="#provisioning_concepts">Provisioning concepts</a><ul>
<li><a href="#create_a_persistentvolumeclaim_from_a_storageclass">Create a PersistentVolumeClaim from a StorageClass</a></li>
<li><a href="#raw_block_volume">Raw block volume</a></li>
<li><a href="#using_csi_snapshots">Using CSI snapshots</a></li>
<li><a href="#expanding_pvcs">Expanding PVCs</a></li>
<li><a href="#using_pvc_overrides">Using PVC Overrides</a></li>
</ul>
</li>
<li><a href="#further_reading">Further reading</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you're familiar with the basic concepts of persistent storage on Kubernetes and are looking for an overview of example YAML declarations for different object types supported by the HPE CSI driver, <a href="https://github.com/hpe-storage/csi-driver/tree/master/examples/kubernetes">visit the source code repo</a> on GitHub.</p>
</div>
<h2 id="enabling_csi_snapshots">Enabling CSI snapshots<a class="headerlink" href="#enabling_csi_snapshots" title="Permanent link">&para;</a></h2>
<p>Support for <code>VolumeSnapshotClass</code> is available from Kubernetes 1.17+. The snapshot beta CRDs and the common snapshot controller needs to be installed manually. As per Kubernetes SIG Storage, these should not be installed as part of a CSI driver and should be deployed by the Kubernetes cluster vendor or user.</p>
<p>Install snapshot beta CRDs.</p>
<p> <pre><code class=markdown>kubectl create  -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
kubectl create  -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
kubectl create  -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
</code></pre></p>
<p>Install common snapshot controller.</p>
<p> <pre><code class=markdown>kubectl create -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
kubectl create -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
</code></pre></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <a href="#provisioning_concepts">provisioning</a> section contains examples on how to create <code>VolumeSnapshotClass</code> and <code>VolumeSnapshot</code> objects.</p>
</div>
<h2 id="base_storageclass_parameters">Base StorageClass parameters<a class="headerlink" href="#base_storageclass_parameters" title="Permanent link">&para;</a></h2>
<p>Each CSP has its own set of unique parameters to control the provisioning behavior. These examples serve as a base <code>StorageClass</code> example for each version of Kubernetes. See the respective <a href="../container_storage_provider/index.html">CSP</a> for more elaborate examples.</p>
<div class=md-fenced-code-tabs id=tab-tab-group-2><input name=tab-group-2 type=radio id=tab-group-2-0_markdown checked=checked class=code-tab data-lang=markdown aria-controls=tab-group-2-0_markdown-panel role=tab><label for=tab-group-2-0_markdown class=code-tab-label data-lang=markdown id=tab-group-2-0_markdown-label>K8s 1.15+</label><div class=code-tabpanel role=tabpanel data-lang=markdown id=tab-group-2-0_markdown-panel aria-labelledby=tab-group-2-0_markdown-label><pre><code class=markdown># Renamed csi.storage.k8s.io/resizer-secret-name to
# csi.storage.k8s.io/controller-expand-secret-name
#
# Alpha features: PVC cloning and Pod inline ephemeral volumes
#
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;
  name: hpe-storageclass
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/controller-expand-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/controller-expand-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/provisioner-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  description: &quot;Volume created by the HPE CSI Driver for Kubernetes&quot;
reclaimPolicy: Delete
allowVolumeExpansion: true
</code></pre></div><input name=tab-group-2 type=radio id=tab-group-2-1_markdown class=code-tab data-lang=markdown aria-controls=tab-group-2-1_markdown-panel role=tab><label for=tab-group-2-1_markdown class=code-tab-label data-lang=markdown id=tab-group-2-1_markdown-label>K8s 1.14</label><div class=code-tabpanel role=tabpanel data-lang=markdown id=tab-group-2-1_markdown-panel aria-labelledby=tab-group-2-1_markdown-label><pre><code class=markdown># Alpha feature: volume expansion
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;
  name: hpe-storageclass
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/resizer-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/resizer-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/provisioner-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  description: &quot;Volume created by the HPE CSI Driver for Kubernetes&quot;
reclaimPolicy: Delete
# Required to allow volume expansion
allowVolumeExpansion: true
</code></pre></div><input name=tab-group-2 type=radio id=tab-group-2-2_markdown class=code-tab data-lang=markdown aria-controls=tab-group-2-2_markdown-panel role=tab><label for=tab-group-2-2_markdown class=code-tab-label data-lang=markdown id=tab-group-2-2_markdown-label>K8s 1.13</label><div class=code-tabpanel role=tabpanel data-lang=markdown id=tab-group-2-2_markdown-panel aria-labelledby=tab-group-2-2_markdown-label><pre><code class=markdown>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;
  name: hpe-storageclass
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/controller-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/provisioner-secret-name: &lt;backend&gt;-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  description: &quot;Volume created by the HPE CSI Driver for Kubernetes&quot;
reclaimPolicy: Delete
</code></pre></div></div>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Replace <code>&lt;backend&gt;-secret</code> with a <code>Secret</code> relevant to the backend being referenced.<br />
• <code>nimble-secret</code> for HPE Nimble Storage<br />
• <code>primera3par-secret</code> for HPE 3PAR and Primera<br />
The example <code>StorageClass</code> does not work with the <code>primera3par</code> CSP version 1.0.0, use the example from <a href="#provisioning_concepts">provisioning concepts</a> instead.</p>
</div>
<h2 id="provisioning_concepts">Provisioning concepts<a class="headerlink" href="#provisioning_concepts" title="Permanent link">&para;</a></h2>
<p>These instructions are provided as an example on how to use the HPE CSI Driver with a <a href="../container_storage_provider/index.html">CSP</a> supported by HPE.</p>
<ul>
<li><a href="#create_a_persistentvolumeclaim_from_a_storageclass">Create a PersistentVolumeClaim from a StorageClass</a></li>
<li><a href="#raw_block_volume">Raw block volume</a></li>
<li><a href="#using_csi_snapshots">Using CSI snapshots</a></li>
<li><a href="#expanding_pvcs">Expanding PVCs</a></li>
<li><a href="#using_pvc_overrides">Using PVC overrides</a></li>
</ul>
<h3 id="create_a_persistentvolumeclaim_from_a_storageclass">Create a PersistentVolumeClaim from a StorageClass<a class="headerlink" href="#create_a_persistentvolumeclaim_from_a_storageclass" title="Permanent link">&para;</a></h3>
<p>The below YAML declarations are meant to be created with <code>kubectl create</code>. Either copy the content to a file on the host where <code>kubectl</code> is being executed, or copy &amp; paste into the terminal, like this:</p>
<p> <pre><code class=markdown>kubectl create -f-
&lt; paste the YAML &gt;
^D (CTRL + D)
</code></pre></p>
<p>To get started, create a <code>StorageClass</code> API object referencing the CSI driver <code>Secret</code> relevant to the backend.</p>
<p>These examples are for Kubernetes 1.15+</p>
<div class=md-fenced-code-tabs id=tab-tab-group-4><input name=tab-group-4 type=radio id=tab-group-4-0_yaml checked=checked class=code-tab data-lang=yaml aria-controls=tab-group-4-0_yaml-panel role=tab><label for=tab-group-4-0_yaml class=code-tab-label data-lang=yaml id=tab-group-4-0_yaml-label>HPE Nimble Storage</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-4-0_yaml-panel aria-labelledby=tab-group-4-0_yaml-label><pre><code class=yaml>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: hpe-scod
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/controller-expand-secret-name: nimble-secret
  csi.storage.k8s.io/controller-expand-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: nimble-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: nimble-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: nimble-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/provisioner-secret-name: nimble-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  description: &quot;Volume created by the HPE CSI Driver for Kubernetes&quot;
  accessProtocol: iscsi
reclaimPolicy: Delete
allowVolumeExpansion: true
</code></pre></div><input name=tab-group-4 type=radio id=tab-group-4-1_yaml class=code-tab data-lang=yaml aria-controls=tab-group-4-1_yaml-panel role=tab><label for=tab-group-4-1_yaml class=code-tab-label data-lang=yaml id=tab-group-4-1_yaml-label>HPE 3PAR and Primera</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-4-1_yaml-panel aria-labelledby=tab-group-4-1_yaml-label><pre><code class=yaml>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: hpe-scod
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/controller-expand-secret-name: primera3par-secret
  csi.storage.k8s.io/controller-expand-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: primera3par-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: primera3par-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: primera3par-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/provisioner-secret-name: primera3par-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  cpg: FC_r6
  provisioning_type: tpvv
  accessProtocol: fc
reclaimPolicy: Delete
allowVolumeExpansion: true
</code></pre></div></div>

<p>Create a <code>PersistentVolumeClaim</code>. This object declaration ensures a <code>PersistentVolume</code> is created and provisioned on your behalf, make sure to reference the correct <code>.spec.storageClassName</code>:</p>
<p> <pre><code class=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-first-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 32Gi
  storageClassName: hpe-scod
</code></pre></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In most environments, there is a default <code>StorageClass</code> declared on the cluster. In such a scenario, the <code>.spec.storageClassName</code> can be omitted. The default <code>StorageClass</code> is controlled by an annotation: <code>.metadata.annotations.storageclass.kubernetes.io/is-default-class</code> set to either <code>"true"</code> or <code>"false"</code>.</p>
</div>
<p>After the <code>PersistentVolumeClaim</code> has been declared, check that a new <code>PersistentVolume</code> is created based on your claim:</p>
<p> <pre><code class=markdown>kubectl get pv
NAME              CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM                STORAGECLASS AGE
pvc-13336da3-7... 32Gi     RWO          Delete         Bound  default/my-first-pvc hpe-scod     3s
</code></pre></p>
<p>The above output means that the HPE CSI Driver successfully provisioned a new volume. The volume is not attached to any node yet. It will only be attached to a node if a scheduled workload requests the <code>PersistentVolumeClaim</code>. Now, let us create a <code>Pod</code> that refers to the above volume. When the <code>Pod</code> is created, the volume will be attached, formatted and mounted according to the specification.</p>
<p> <pre><code class=yaml>kind: Pod
apiVersion: v1
metadata:
  name: my-pod
spec:
  containers:
    - name: pod-datelog-1
      image: nginx
      command: [&quot;bin/sh&quot;]
      args: [&quot;-c&quot;, &quot;while true; do date &gt;&gt; /data/mydata.txt; sleep 1; done&quot;]
      volumeMounts:
        - name: export1
          mountPath: /data
    - name: pod-datelog-2
      image: debian
      command: [&quot;bin/sh&quot;]
      args: [&quot;-c&quot;, &quot;while true; do date &gt;&gt; /data/mydata.txt; sleep 1; done&quot;]
      volumeMounts:
        - name: export1
          mountPath: /data
  volumes:
    - name: export1
      persistentVolumeClaim:
        claimName: my-first-pvc
</code></pre></p>
<p>Check if the <code>Pod</code> is running successfully.</p>
<p> <pre><code class=markdown>kubectl get pod my-pod 
NAME        READY   STATUS    RESTARTS   AGE
my-pod      2/2     Running   0          2m29s
</code></pre></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A simple <code>Pod</code> does not provide any automatic recovery if the node the <code>Pod</code> is scheduled on crashes or become unresponsive. Please see <a href="https://kubernetes.io/docs/concepts/workloads/">the official Kubernetes documentation</a> for different workload types that provide automatic recovery. A shortlist of recommended workload types that are suitable for persistent storage is available in <a href="https://datamattsson.tumblr.com/post/182297931146/highly-available-stateful-workloads-on-kubernetes">this blog post</a> and best practices are outlined in <a href="https://datamattsson.tumblr.com/post/185031432701/best-practices-for-stateful-workloads-on">this blog post</a>.</p>
</div>
<h3 id="raw_block_volume">Raw block volume<a class="headerlink" href="#raw_block_volume" title="Permanent link">&para;</a></h3>
<p>The default <code>volumeMode</code> for a <code>PersistentVolumeClaim</code> is <code>Filesystem</code>. If a raw block volume is desired, <code>volumeMode</code> needs to be set to <code>Block</code>. No filesystem will be created. Example:</p>
<p> <pre><code class=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-block
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 32Gi
  storageClassName: hpe-scod
  volumeMode: Block
</code></pre></p>
<p>Mapping the device in a <code>Pod</code> specification is slightly different than using regular filesystems as a <code>volumeDevices</code> section is added instead of a <code>volumeMounts</code> stanza:</p>
<p> <pre><code class=yaml>apiVersion: v1
kind: Pod
metadata:
  name: my-pod-block
spec:
  containers:
    - name: my-null-pod
      image: fedora:31
      command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
      args: [ &quot;tail -f /dev/null&quot; ]
      volumeDevices:
        - name: data
          devicePath: /dev/xvda
  volumes:
    - name: data
      persistentVolumeClaim:
        claimName: my-pvc-block
</code></pre></p>
<h3 id="using_csi_snapshots">Using CSI snapshots<a class="headerlink" href="#using_csi_snapshots" title="Permanent link">&para;</a></h3>
<p>CSI introduces snapshots as native objects in Kubernetes that allows end-users to provision <code>VolumeSnapshot</code> objects from an existing <code>PersistentVolumeClaim</code>. New PVCs may then be created using the snapshot as a source. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Ensure <a href="#enabling_csi_snapshots">CSI snapshots are enabled</a>. </p>
</div>
<p>Start by creating a <code>VolumeSnapshotClass</code> referencing the <code>Secret</code> and defining additional snapshot parameters.</p>
<p>Kubernetes 1.17+ (CSI snapshots in beta)</p>
<div class=md-fenced-code-tabs id=tab-tab-group-11><input name=tab-group-11 type=radio id=tab-group-11-0_yaml checked=checked class=code-tab data-lang=yaml aria-controls=tab-group-11-0_yaml-panel role=tab><label for=tab-group-11-0_yaml class=code-tab-label data-lang=yaml id=tab-group-11-0_yaml-label>HPE Nimble Storage</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-11-0_yaml-panel aria-labelledby=tab-group-11-0_yaml-label><pre><code class=yaml>apiVersion: snapshot.storage.k8s.io/v1beta1
kind: VolumeSnapshotClass
metadata:
  name: hpe-snapshot
  annotations:
    snapshot.storage.kubernetes.io/is-default-class: &quot;true&quot;
driver: csi.hpe.com
deletionPolicy: Delete
parameters:
  description: &quot;Snapshot created by the HPE CSI Driver&quot;
  csi.storage.k8s.io/snapshotter-secret-name: nimble-secret
  csi.storage.k8s.io/snapshotter-secret-namespace: kube-system
</code></pre></div><input name=tab-group-11 type=radio id=tab-group-11-1_yaml class=code-tab data-lang=yaml aria-controls=tab-group-11-1_yaml-panel role=tab><label for=tab-group-11-1_yaml class=code-tab-label data-lang=yaml id=tab-group-11-1_yaml-label>HPE 3PAR and Primera</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-11-1_yaml-panel aria-labelledby=tab-group-11-1_yaml-label><pre><code class=yaml>apiVersion: snapshot.storage.k8s.io/v1beta1
kind: VolumeSnapshotClass
metadata:
  name: hpe-snapshot
  annotations:
    snapshot.storage.kubernetes.io/is-default-class: &quot;true&quot;
driver: csi.hpe.com
deletionPolicy: Delete
parameters:
  description: &quot;Snapshot created by the HPE CSI Driver&quot;
  csi.storage.k8s.io/snapshotter-secret-name: primera3par-secret
  csi.storage.k8s.io/snapshotter-secret-namespace: kube-system
</code></pre></div></div>

<p>Create a <code>VolumeSnapshot</code>. This will create a new snapshot of the volume.</p>
<p> <pre><code class=yaml>apiVersion: snapshot.storage.k8s.io/v1beta1
kind: VolumeSnapshot
metadata:
  name: my-snapshot
spec:
  source:
    persistentVolumeClaimName: my-pvc
</code></pre></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If a specific <code>VolumeSnapshotClass</code> is desired, use <code>.spec.snapshotClassName</code> to call it out.</p>
</div>
<p>Check that a new <code>VolumeSnapshot</code> is created based on your claim:</p>
<p> <pre><code class=markdown>kubectl describe volumesnapshot my-snapshot
Name:         my-snapshot
Namespace:    default
...
Status:
  Creation Time:  2019-05-22T15:51:28Z
  Ready:          true
  Restore Size:   32Gi
</code></pre></p>
<p>It's now possible to create a new <code>PersistentVolumeClaim</code> from the <code>VolumeSnapshot</code>.</p>
<p> <pre><code class=yaml>---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-from-snapshot
spec:
  dataSource:
    name: my-snapshot
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 32Gi
</code></pre></p>
<div class="admonition caution">
<p class="admonition-title">Important</p>
<p>The size in <code>.spec.resources.requests.storage</code> must match the <code>.spec.dataSource</code> size.</p>
</div>
<p>The <code>.data.dataSource</code> attribute may also clone <code>PersistentVolumeClaim</code> directly, without creating a <code>VolumeSnapshot</code>.</p>
<p> <pre><code class=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-from-pvc
spec:
  dataSource:
    name: my-pvc
    kind: PersistentVolumeClaim
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 32Gi
</code></pre></p>
<p>Again, the size in <code>.spec.resources.requests.storage</code> must match the source <code>PersistentVolumeClaim</code>. This can get sticky from an automation perspective as volume expansion is being used on the source volume. It's recommended to inspect the source <code>PersistentVolumeClaim</code> or <code>VolumeSnapshot</code> size prior to creating a clone.</p>
<div class="admonition seealso">
<p class="admonition-title">Learn more</p>
<p>For a more comprehensive tutorial on how to use snapshots and clones with CSI on Kubernetes 1.17, see <a href="https://developer.hpe.com/blog/PklOy39w8NtX6M2RvAxW/hpe-csi-driver-for-kubernetes-snapshots-clones-and-volume-expansion">HPE CSI Driver for Kubernetes: Snapshots, Clones and Volume Expansion</a> on HPE DEV.</p>
</div>
<h3 id="expanding_pvcs">Expanding PVCs<a class="headerlink" href="#expanding_pvcs" title="Permanent link">&para;</a></h3>
<p>To perform expansion operations on Kubernetes 1.14+, you must enhance your <code>StorageClass</code> with some additional attributes. Please see <a href="#base_storageclass_parameters">base <code>StorageClass</code> parameters</a>.</p>
<p>Then, a volume provisioned by a <code>StorageClass</code> with expansion attributes may have its <code>PersistentVolumeClaim</code> expanded by altering the <code>.spec.resources.requests.storage</code> key of the <code>PersistentVolumeClaim</code>.</p>
<p>This may be done by the <code>kubectl patch</code> command.</p>
<p> <pre><code class=markdown>kubectl patch pvc/my-pvc --patch '{&quot;spec&quot;: {&quot;resources&quot;: {&quot;requests&quot;: {&quot;storage&quot;: &quot;64Gi&quot;}}}}'
persistentvolumeclaim/my-pvc patched
</code></pre></p>
<p>The new <code>PersistentVolumeClaim</code> size may be observed with <code>kubectl get pvc/my-pvc</code> after a few moments.</p>
<h3 id="using_pvc_overrides">Using PVC Overrides<a class="headerlink" href="#using_pvc_overrides" title="Permanent link">&para;</a></h3>
<p>The HPE CSI Driver allows the <code>PersistentVolumeClaim</code> to override the <code>StorageClass</code> parameters by annotating the <code>PersistentVolumeClaim</code>. Define the parameters allowed to be overridden in the <code>StorageClass</code> by setting the <code>allowOverrides</code> parameter:</p>
<div class=md-fenced-code-tabs id=tab-tab-group-17><input name=tab-group-17 type=radio id=tab-group-17-0_yaml checked=checked class=code-tab data-lang=yaml aria-controls=tab-group-17-0_yaml-panel role=tab><label for=tab-group-17-0_yaml class=code-tab-label data-lang=yaml id=tab-group-17-0_yaml-label>HPE Nimble Storage</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-17-0_yaml-panel aria-labelledby=tab-group-17-0_yaml-label><pre><code class=yaml>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: my-scod-override
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: xfs
  csi.storage.k8s.io/provisioner-secret-name: nimble-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: nimble-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: nimble-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: nimble-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  description: &quot;Volume provisioned by the HPE CSI Driver&quot;
  accessProtocol: iscsi
  allowOverrides: description,accessProtocol
</code></pre></div><input name=tab-group-17 type=radio id=tab-group-17-1_yaml class=code-tab data-lang=yaml aria-controls=tab-group-17-1_yaml-panel role=tab><label for=tab-group-17-1_yaml class=code-tab-label data-lang=yaml id=tab-group-17-1_yaml-label>HPE 3PAR and Primera</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-17-1_yaml-panel aria-labelledby=tab-group-17-1_yaml-label><pre><code class=yaml>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: my-scod-override
provisioner: csi.hpe.com
parameters:
  csi.storage.k8s.io/fstype: ext4
  csi.storage.k8s.io/provisioner-secret-name: primera3par-secret
  csi.storage.k8s.io/provisioner-secret-namespace: kube-system
  csi.storage.k8s.io/controller-publish-secret-name: primera3par-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: kube-system
  csi.storage.k8s.io/node-stage-secret-name: primera3par-secret
  csi.storage.k8s.io/node-stage-secret-namespace: kube-system
  csi.storage.k8s.io/node-publish-secret-name: primera3par-secret
  csi.storage.k8s.io/node-publish-secret-namespace: kube-system
  cpg: FC_r6
  provisioning_type: tpvv
  accessProtocol: iscsi
  allowOverrides: cpg,provisioning_type
</code></pre></div></div>

<p>The end-user may now control those parameters (the <code>StorageClass</code> provides the default values).</p>
<div class=md-fenced-code-tabs id=tab-tab-group-18><input name=tab-group-18 type=radio id=tab-group-18-0_yaml checked=checked class=code-tab data-lang=yaml aria-controls=tab-group-18-0_yaml-panel role=tab><label for=tab-group-18-0_yaml class=code-tab-label data-lang=yaml id=tab-group-18-0_yaml-label>HPE Nimble Storage</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-18-0_yaml-panel aria-labelledby=tab-group-18-0_yaml-label><pre><code class=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-override
  annotations:
    csi.hpe.com/description: &quot;This is my custom description&quot;
    csi.hpe.com/accessProtocol: fc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: hpe-scod-override
</code></pre></div><input name=tab-group-18 type=radio id=tab-group-18-1_yaml class=code-tab data-lang=yaml aria-controls=tab-group-18-1_yaml-panel role=tab><label for=tab-group-18-1_yaml class=code-tab-label data-lang=yaml id=tab-group-18-1_yaml-label>HPE 3PAR and Primera</label><div class=code-tabpanel role=tabpanel data-lang=yaml id=tab-group-18-1_yaml-panel aria-labelledby=tab-group-18-1_yaml-label><pre><code class=yaml>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc-override
  annotations:
    csi.hpe.com/provisioning_type: full
    csi.hpe.com/cpg: SSD_r6
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: hpe-scod-override
</code></pre></div></div>

<h2 id="further_reading">Further reading<a class="headerlink" href="#further_reading" title="Permanent link">&para;</a></h2>
<p>The <a href="https://kubernetes.io/docs/concepts/storage/volumes/">official Kubernetes documentation</a> contains comprehensive documentation on how to markup <code>PersistentVolumeClaim</code> and <code>StorageClass</code> API objects to tweak certain behaviors.</p>
<p>Each CSP has a set of unique <code>StorageClass</code> parameters that may be tweaked to accommodate a wide variety of use cases. Please see the documentation of <a href="../container_storage_provider/index.html">the respective CSP for more details</a>.</p>
              
            </div>
          </div>

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="diagnostics.html" class="btn btn-neutral float-right" title="Diagnostics">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="deployment.html" class="btn btn-neutral" title="Deployment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
    <p>Copyright 2020 Hewlett Packard Enterprise Development LP<br />Give <a href="https://github.com/hpe-storage/scod/issues/new?title=csi_driver/using.html">feedback</a> on this page.</p>
    
  </div>
</footer>

        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="deployment.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="diagnostics.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
